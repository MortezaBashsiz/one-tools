#!/bin/bash

REALPATH=$(readlink -f $0)
BOOTSTRAP_DIR=bootstrap

test -n "$1" && BOOTSTRAP_DIR=bootstrap.$1

cd `dirname $REALPATH`

for host in $(ls $BOOTSTRAP_DIR/host/*.host 2>/dev/null); do
    unset IM VMM NET
    source $host

    HOSTNAME=$(basename $host)
    HOSTNAME=${HOSTNAME%%.host}

    onehost create $HOSTNAME -i $IM -v $VMM -n $NET
done

unset DEFAULT_DS
for datastore in $(ls $BOOTSTRAP_DIR/datastore/*.datastore 2>/dev/null); do
    DS_ID=$(onedatastore create $datastore|awk '{print $2}')
    onedatastore chmod $DS_ID 644

    # If it's the first registered datastore, mark it as default
    [ -z "$DEFAULT_DS" ] && DEFAULT_DS=$DS_ID

    # If it has DEFAULT inside the template mark it as default
    if cat $datastore | grep -q DEFAULT; then
        DEFAULT_DS=$DS_ID
    fi
done

unset DEFAULT_USER
unset DEFAULT_PASSWORD
for user in $(ls $BOOTSTRAP_DIR/user/*.user 2>/dev/null); do
    username=$(cat $user|cut -d: -f1)
    password=$(cat $user|cut -d: -f2)

    user_file=$(basename $user)
    if [ "$user_file" = "default.user" ]; then
        DEFAULT_USER="$username"
        DEFAULT_PASSWORD="$password"
    fi

    oneuser create $username $password
done

## Change to the default user if provided
#if [ -n "$DEFAULT_USER" -a -n "$DEFAULT_PASSWORD" ]; then
#    TMP=$(mktemp)
#    echo "$DEFAULT_USER:$DEFAULT_PASSWORD" > $TMP
#    export ONE_AUTH=$TMP
#fi

for vnet in $(ls $BOOTSTRAP_DIR/vnet/*.vnet 2>/dev/null); do
    onevnet create $vnet
done

# If no datastore was created, used DS 1 as the default
[ -z "DEFAULT_DS" ] && DEFAULT_DS=1

for image in $(ls $BOOTSTRAP_DIR/image/*.image 2>/dev/null); do
    oneimage create $image -d $DEFAULT_DS
done

for template in $(ls $BOOTSTRAP_DIR/template/*.template 2>/dev/null); do
    onetemplate create $template
done
